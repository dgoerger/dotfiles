#!/bin/ksh

### OpenBSD 6.2
# Linode guide:
#   https://www.linode.com/docs/tools-reference/custom-kernels-distros/install-a-custom-distribution-on-a-linode/#install-a-custom-distribution
#   installer disk: 400MB
#   # echo -e '# for Linode\nset tty com0\nset timeout 45' | tee /etc/boot.conf
# Desktop guide:
#   https://www.bsdnow.tv/tutorials/fde#OpenBSD
#   NB: dhclient.conf below assumes ethernet, not wifi

echo "Have you added your pubkey to ~/.ssh/authorized_keys ? (y/N)"
read -r yesno
if [[ "${yesno}" != 'yes' ]] || [[ "${yesno}" != 'y' ]] || [[ "${yesno}" != 'Y' ]]; then
  echo "please don't lock yourself out kthx"
  exit 1
fi
if [[ "$(id -u)" != '0' ]]; then
  echo "please become root"
  exit 2
fi
echo "Please enter DNS domain search domain base:"
read -r dnsbase

ftp -o /etc/ssh/sshd_config https://raw.githubusercontent.com/dgoerger/dotfiles/master/sshd_config

echo 'https://fastly.cdn.openbsd.org/pub/OpenBSD' | tee /etc/installurl

#sed -i 's/ffs\ rw/ffs\ rw\,softdep\,noatime/g' /etc/fstab

pkg_add colordiff curl dnscrypt-proxy fetchmail git hub kpcli lynx mosh mutt--gpgme-sasl ncdu neovim newsboat nmap privoxy pstree rsync surfraw tor tree unzip
ftp -o /usr/local/sbin/pomodoro https://raw.githubusercontent.com/dgoerger/dotfiles/master/scripts/pomodoro.sh
ftp -o /usr/local/sbin/pf_update https://raw.githubusercontent.com/dgoerger/dotfiles/master/openbsd/pf_update.sh
chmod 0555 /usr/local/sbin/pomodoro
chmod 0544 /usr/local/sbin/pf_update
echo -e '\n## CUSTOM\n@weekly /usr/local/sbin/dnsblock\n@daily /usr/local/sbin/pf_update\n@daily /usr/sbin/pkg_add -Uu >/dev/null 2>&1' | tee -a /var/cron/tabs/root

if host "$(hostname)"; then
  echo -e "\ndomain $(hostname) {\n  domain key \"/etc/ssl/private/$(hostname).key\"\n  domain certificate \"/etc/ssl/$(hostname).crt\"\n  domain full chain certificate \"/etc/ssl/$(hostname).fullchain.pem\"\n  sign with letsencrypt\n}" | tee -a /etc/acme-client.conf
  acme-client -vAD "$(hostname)"
  echo -e "@daily /usr/sbin/rcctl start -f httpd 2>/dev/null && /usr/sbin/acme-client $(hostname) && /usr/sbin/rcctl stop httpd 2>/dev/null" | tee -a /var/cron/tabs/root
fi

# unbound
ftp -o /var/unbound/etc/named.cache https://www.internic.net/domain/named.cache
unbound-anchor -a /var/unbound/db/root.key
ftp -o /var/unbound/etc/unbound.conf https://raw.githubusercontent.com/dgoerger/dotfiles/master/unbound.conf
ftp -o /usr/local/sbin/dnsblock https://raw.githubusercontent.com/dgoerger/dotfiles/master/scripts/dnsblock.sh
chmod 0544 /usr/local/sbin/dnsblock
rcctl enable unbound
rcctl disable sndio
mkdir -p /usr/local/etc
touch /usr/local/etc/blocklist.conf
rcctl start unbound
sh /usr/local/sbin/dnsblock
echo -e "interface \"em0\" {\n  supersede domain-name \"${dnsbase}\";\n  supersede domain-name-servers 127.0.0.1;\n  request subnet-mask, broadcast-address, time-offset, routers;\n  require subnet-mask;\n}" | tee /etc/dhclient.conf
sh /etc/netstart

# privoxy + tor
ftp -o /etc/privoxy/config https://raw.githubusercontent.com/dgoerger/dotfiles/master/privoxy.config
rcctl enable tor
rcctl enable privoxy
rcctl start tor
rcctl start privoxy

# snap
ftp -o /usr/local/sbin/snap https://raw.githubusercontent.com/qbit/snap/master/snap
chmod 0544 /usr/local/sbin/snap
