#!/bin/ksh

### OpenBSD 6.2
# Linode guide:
#   https://www.linode.com/docs/tools-reference/custom-kernels-distros/install-a-custom-distribution-on-a-linode/#install-a-custom-distribution
#   installer disk: 400MB
#   # echo -e '# for Linode\nset tty com0\nset timeout 45' | tee /etc/boot.conf
# Desktop guide:
#   https://www.bsdnow.tv/tutorials/fde#OpenBSD
#   NB: dhclient.conf below assumes ethernet, not wifi

echo "Have you added your pubkey to ~/.ssh/authorized_keys ? (y/N)"
read -r yesno
if [[ "${yesno}" != 'yes' ]] || [[ "${yesno}" != 'y' ]] || [[ "${yesno}" != 'Y' ]]; then
  echo "please don't lock yourself out kthx"
  return 1
fi
if [[ "$(id -u)" != '0' ]]; then
  echo "please become root"
  return 2
fi
echo "Please enter DNS domain search domain base:"
read -r dnsbase

ftp -o /etc/ssh/sshd_config https://raw.githubusercontent.com/dgoerger/dotfiles/master/sysconfs/sshd_config

echo 'https://fastly.cdn.openbsd.org/pub/OpenBSD' | tee /etc/installurl

#sed -i 's/ffs\ rw/ffs\ rw\,softdep\,noatime/g' /etc/fstab

# GNOME desktop
#pkg_add gnome-control-center gnome-desktop gnome-keyring gnome-session gnome-shell-extensions gnome-terminal

# desktop apps
#pkg_add eog evince--light firefox gedit gnome-screenshot gnome-tweak-tool iridium keepassxc mpv
#pkg_add cabal-install exiv2 ffmpeg ghc mosh youtube-dl

# cli apps
pkg_add abook colordiff fetchmail git kpcli lynx mosh mutt ncdu neovim newsboat opmsg p5-Term-ReadLine-Gnu pkglocatedb privoxy rsync shellcheck surfraw toot tor tree weechat weechat-lua wtf

ftp -o /usr/local/sbin/dnsblock https://raw.githubusercontent.com/dgoerger/dotfiles/master/bin/dnsblock.sh
ftp -o /usr/local/sbin/pf_bruteforcers https://raw.githubusercontent.com/dgoerger/dotfiles/master/bin/pf_bruteforcers.sh
ftp -o /usr/local/sbin/pf_update https://raw.githubusercontent.com/dgoerger/dotfiles/master/bin/pf_update.sh
chmod 0544 /usr/local/sbin/dnsblock
chmod 0544 /usr/local/sbin/pf_bruteforcers
chmod 0544 /usr/local/sbin/pf_update
echo '## CUSTOM' | tee -a /var/cron/tabs/root
echo '@weekly /usr/local/sbin/dnsblock' | tee -a /var/cron/tabs/root
echo '*/5 * * * * /usr/local/sbin/pf_bruteforcers' | tee -a /var/cron/tabs/root
echo '@daily /usr/local/sbin/pf_update' | tee -a /var/cron/tabs/root
echo '@daily /usr/sbin/pkg_add -Uu >/dev/null 2>&1' | tee -a /var/cron/tabs/root

if host "$(hostname)"; then
  echo -e "\\ndomain $(hostname) {\\n  domain key \"/etc/ssl/private/$(hostname).key\"\\n  domain certificate \"/etc/ssl/$(hostname).crt\"\\n  domain full chain certificate \"/etc/ssl/$(hostname).fullchain.pem\"\\n  sign with letsencrypt\\n}" | tee -a /etc/acme-client.conf
  acme-client -vAD "$(hostname)"
  echo -e "@daily /usr/sbin/rcctl start -f httpd 2>/dev/null && /usr/sbin/acme-client $(hostname) && /usr/sbin/rcctl stop httpd 2>/dev/null" | tee -a /var/cron/tabs/root
fi

# unbound
ftp -o /var/unbound/etc/named.cache https://www.internic.net/domain/named.cache
unbound-anchor -a /var/unbound/db/root.key
ftp -o /var/unbound/etc/unbound.conf https://raw.githubusercontent.com/dgoerger/dotfiles/master/sysconfs/unbound.conf
rcctl enable unbound
rcctl disable sndio
mkdir -p /usr/local/etc
touch /usr/local/etc/blocklist.conf
rcctl start unbound
sh /usr/local/sbin/dnsblock
echo -e "interface \"em0\" {\\n  supersede domain-name \"${dnsbase}\";\\n  supersede domain-name-servers 127.0.0.1;\\n  request subnet-mask, broadcast-address, time-offset, routers;\\n  require subnet-mask;\\n}" | tee /etc/dhclient.conf
sh /etc/netstart

# privoxy + tor
ftp -o /etc/privoxy/config https://raw.githubusercontent.com/dgoerger/dotfiles/master/sysconfs/privoxy_config
rcctl enable tor
rcctl enable privoxy
rcctl start tor
rcctl start privoxy

# snap
ftp -o /usr/local/bin/snap https://raw.githubusercontent.com/qbit/snap/master/snap
chmod 0544 /usr/local/bin/snap
